# REQUIREMENT: 
# - set a storage class with ability to serve ReadWriteOnce
#   Name: storageClassName, and/or set anchor &Å›torage_class
#   Description: Set a storage class for the resources that are reused for multi-mount-points in cluster. To reduce wasteful copying we allow to use the same dataset volume to be mounted multiple times.
#   Default: microk8s-hostpath, use local-path for k3s/Rancher Desktop

# Set global values to overide default
environment: "remote"

# Storage class used by the KTH cluster
storageClass: &storage_class ontap-nas
#storageClass: &storage_class local-path

# Storage access mode
access_mode: &access_mode ReadWriteMany
#access_mode: &access_mode ReadWriteOnce
accessmode: *access_mode

namespace: serve-dev
commonLabels: {}
commonAnnotations: {}
kubeconfig: ""
cluster_domain: cluster.local

studio:
  existingSecret: ""
  storageClass: *storage_class
  servicename: studio
  replicas: 1
  strategy:
    type: RollingUpdate
  debug: true
  init: true
  reset_db: false
  enable_project_extra_settings: false
  inactive_users: true
  custom_apps:
    enabled: true
    apps:
    - "common"
  domain: serve-dev.scilifelab.se
  session_cookie_domain: .serve-dev.scilifelab.se
  custom_migrations:
    enabled: false
    apps:
      user: "studio.migrations.user"
      control: "studio.migrations.control"
  auth_user_model:
    override: false
    model: "user.User"
  csrf_trusted_origins: "https://serve-dev.scilifelab.se:8082" #if you want to port-forward the web server
  session_cookie_age: 3600
  rateLimit:
    authEndpoint:
      rate: "10/minute" # Empty = disabled
      whitelist: "10.42.0.0/16" # Empty = no whitelist
  kubeconfig_file: /app/kubeconfig/config
  kubeconfig_dir: /app/kubeconfig/
  kube_api_request_timeout: 1
  static:
    replicas: 1
    strategy:
      type: Recreate
    image:
      repository: ghcr.io/scilifelabdatacentre/serve/serve-ingress
      tag: develop-20251208
      pullPolicy: Always
    resources:
      limits:
        cpu: 1
        memory: "512Mi"
      requests:
        cpu: "100m"
        memory: "256Mi"
  image:
    repository: ghcr.io/scilifelabdatacentre/serve/serve-studio
    tag: develop-20251208
    pullPolicy: Always
  resources:
    limits:
      cpu: 16
      memory: "4Gi"
    requests:
      cpu: 8
      memory: "2Gi"
  storage:
    storageClass: *storage_class
  media:
    storage:
      storageClass: *storage_class
      size: "5Gi"
      accessModes: *access_mode
      claimName: studio-media
      mountStudio: true
    mount_path: /app/media/
  superUser: admin
  superuserPassword:
  superuserEmail: admin@serve.scilifelab.se
  djangoAdminUrlPath: whale
  eventUser:
  eventuserPassword:
  eventuserEmail: event_user@serve.scilifelab.se
  version: studio
  securityContext:
    enabled: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    privileged: false
  readinessProbe:
    enabled: true
    httpGet:
      path: /status
      port: 8080
      scheme: HTTP
    initialDelaySeconds: 20
    periodSeconds: 10
  livenessProbe:
    enabled: true
    tcpSocket:
      port: 8080
    initialDelaySeconds: 20
    periodSeconds: 20
  djangoSecret:
  altchaHmacKey:
  axes:
    failure_limit: 5
    cooloff_time: 0.1
    ipware_proxy_count: 1
  emailService:
    enabled: true
    hostUser: noreply-serve@scilifelab.se
    hostPassword:
    host: smtp.gmail.com
    port: 465
    ssl: true
    googleServiceAccount:
      type: ""
      project_id: ""
      private_key_id: ""
      private_key: ""
      client_email: ""
      client_id: ""
      auth_uri: ""
      token_uri: ""
      auth_provider_x509_cert_url: ""
      client_x509_cert_url: ""
      universe_domain: ""
  disabledAppInstanceFields:
    enabled: false
    fields:
      - ''
  connectionPool:
    enabled: true
    minSize: 4
    maxSize: 10
    timeout: 30
    maxIdle: 300
  githubApiToken:
  githubApiUsername:
  dockerhubToken:
  dockerhubUsername:
  invenioEnabled: false
  invenioUrl:
  invenioApiToken:

postgresql:
  enabled: true
  fullnameOverride: serve-studio-postgres
  commonAnnotations: {"reloader.stakater.com/auto": "true"}
  auth:
    username: stackn
    database: stackn
    password:
    existingSecret: serve-bitwarden-secret
    secretKeys:
      adminPasswordKey: postgresql-password
      userPasswordKey: postgresql-password
  storageClass: *storage_class
  primary:
    service:
      ports:
        postgresql: 5432
    extraEnvVars:
      - name: POSTGRESQL_MAX_CONNECTIONS
        value: "300"
    persistence:
      enabled: true
      size: "10Gi"
      accessModes:
        - *access_mode
      storageClass: *storage_class
    podLabels: {"app":"studio-app"}
  image:
    repository: "bitnamilegacy/postgresql"
    tag: "15.6.0-debian-12-r15"

redis:
  enabled: true
  auth:
    existingSecret: serve-bitwarden-secret
    existingSecretPasswordKey: redis-password
  commonAnnotations: {"reloader.stakater.com/auto": "true"}
  master:
    podLabels: {"app":"studio-app"}
  replica:
    replicaCount: 1
    podLabels: {"app":"studio-app"}
  image:
    repository: "bitnamilegacy/redis"
    tag: "7.2.4-debian-12-r9"

rabbitmq:
  enabled: true
  auth:
    existingPasswordSecret: serve-bitwarden-secret
    existingPasswordSecretKey: rabbitmq-password
    erlangCookie:
  commonAnnotations: {"reloader.stakater.com/auto": "true"}
  podLabels: {"app":"studio-app","allow-api-access": "true"}
  persistence:
    enabled: true
  image:
    repository: "bitnamilegacy/rabbitmq"
    tag: "3.13.1-debian-12-r0"
  resources:
    limits:
      cpu: 2
      ephemeral-storage: 1Gi
      memory: 1024Mi
    requests:
      cpu: 1
      ephemeral-storage: 50Mi
      memory: 512Mi

celeryWorkers:
  replicas: 2
  resources:
    requests:
      cpu: "100m"
      memory: "1Gi"
    limits:
      cpu: "1000m"
      memory: "8Gi"

celeryFlower:
  enabled: false

eventListener:
  image: ghcr.io/scilifelabdatacentre/serve-event-listener/event-listener:v1.4.0
  debug: true
  tlsSSLVerification: "1"            # "0" / "1" / "/path/to/ca.pem"
  appProbeStatuses: "Running,Deleted"  # "" disables probing completely
  resources:
    requests:
      cpu: "100m"
      memory: "1Gi"
    limits:
      cpu: "500m"
      memory: "2Gi"

bitwarden:
  enabled: true

networkPolicy:
  enable: true
  kubernetes:
    cidr: 130.237.255.59/32 # To get kubernetes api server endpoints run: $ kubectl get endpoints kubernetes
    port: 6443 
  internal_cidr: # in-cluster IpBlock cidr, used in allow-internet-[egress|ingress] policy, e.g:
    - 10.0.0.0/8
    - 192.168.0.0/16
    - 172.0.0.0/20
  ingress_controller_namespace: kube-system

serviceAccount:
  create: true
  automountServiceAccountToken: true

rbac:
  create: true

# Enable ingress if you want to access the studio solution from a kubernetes host/localhost.
ingress:
  enabled: true
  annotations: {}
  hosts:
    - host: serve-dev.scilifelab.se
  # setup TLS if you have a platform certificate or use 'tls-acme' if you have certbot deployed and want to generate a certificate.
  tls:
    - secretName: prod-ingress
      hosts:
        - serve-dev.scilifelab.se
  # Enable or disable access to the django admin interface from the university network
  djangoAdminAccessRestriction:
    enabled: true
    # IP address range to allow access to the django admin interface
    whiteListSourceRange: 130.238.0.0/16
  rateLimit:
    rpm: "100"  # Requests per minute

chartcontroller:
  enabled: false
  #addSecret -- if true create chart-controller-secret from cluster_config, if false it must be added manually
  addSecret: false

docker-registry:
  enabled: false

reloader:
  enabled: true
  namespace: serve-dev
  reloader:
    watchGlobally: false

loki:
    enabled: true
    namespace: loki-stack
    host: http://loki-gateway.loki-stack.svc.cluster.local # assumes loki deployed separately in loki-stack namespace with loki helm chart
